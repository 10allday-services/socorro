<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
 "http://www.w3.org/TR/html4/strict.dtd">

<?python
 from calendar import timegm
 from socorro.lib.platforms import platformList
?>

<html xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../includes/common.html" />
  <xi:include href="../includes/site.html" />
<head>
  <title>Crash Reports in ${c.params.signature}</title>

  <script type="text/javascript" src="${h.url_for('/js/MochiKit/MochiKit.js')}"></script>
  <script type="text/javascript" src="${h.url_for('/js/PlotKit/excanvas.js')}"></script>
  <script type="text/javascript" src="${h.url_for('/js/PlotKit/PlotKit_Packed.js')}"></script>

  <style type="text/css">
   #buildid-outer {
     display: none;
   }
   #buildid-div {
     height: 160px;
     width: 500px;
     margin-top: 0.5em;
     margin-bottom: 0.5em;
     margin-left: auto;
     margin-right: auto;
   }
   #buildid-labels {
     float: left;
   }
  </style>    

</head>

<body>

 <div id="content">
 <h1 class="first">Crash Reports in ${c.params.signature}</h1>

 <p>${str(c.params)}</p>


 <div id="buildid-outer">
  <ul id="buildid-labels">
   <li py:for="platform in platformList"
       py:if="len(c.params.platforms) == 0 or platform in c.params.platforms"
       style="color: ${platform.color()}">
     ${platform.name()}
   </li>
  </ul>

  <div id="buildid-div">
  <canvas id="buildid-graph" width="500" height="160"></canvas>
  </div>
 </div>

 ${list_reports(c.reports)}
 
 <table id="buildid-table" class="list">
  <thead>
   <tr>
    <th>Build ID</th>
    <th py:if="len(c.params.platforms) != 1">Crashes</th>
    <th py:for="platform in platformList"
        py:if="len(c.params.platforms) == 0 or platform in c.params.platforms">
     ${platform.name()[:3]}
    </th>
   </tr>
  </thead>
  <tbody>
   <?python row=1?>
   <tr py:for="build in c.builds" class="${h.get_row_class(row)}">
    <td class="human-buildid">${build.build_date.strftime('%Y%m%d%H')}</td>
    <td class="crash-count" py:if="len(c.params.platforms) != 1">
     ${build.count} - ${"%.3f%%" % (build.frequency * 100)}
    </td>
    <td py:for="platform in platformList"
        py:if="len(c.params.platforms) == 0 or platform in c.params.platforms">
     ${getattr(build, 'count_%s' % platform.id())} -
     ${"%.3f%%" % (getattr(build, 'frequency_%s' % platform.id()) * 100)}
    </td>
    <?python row+=1 ?>
   </tr>
  </tbody>
 </table>

 </div>

<!-- end content -->

 <script type="text/javascript">

 var data = [
  <py:for each="build in c.builds" py:if="build.total > 10">
   [ ${timegm(build.build_date.utctimetuple()) * 1000}, ${build.total},
    <py:for each="platform in platformList"
            py:if="len(c.params.platforms) == 0 or platform in c.params.platforms">
     ${getattr(build, 'frequency_%s' % platform.id())},
    </py:for>
   ],
  </py:for>
  null
 ];
 data.pop();

 var total_platforms = ${len(c.params.platforms) == 0 and 3 or len(c.params.platforms)};

 <![CDATA[
 var minDate = 1e+14;
 var maxDate = 0;
 var maxValue = 0;

 var platformData = [];
 for (var p = 0; p < total_platforms; ++p)
   platformData[p] = [];

 for (var i = 0; i < data.length; ++i) {
   var date = data[i][0];
   if (date > maxDate)
     maxDate = date;
   if (date < minDate)
     minDate = date;

   var value = 0;
   for (p = total_platforms - 1; p >= 0; --p) {
     value += data[i][p + 2]
     platformData[p][i] = [date, value];
   }
   if (value > maxValue)
     maxValue = value;
 }

 function pad2(n)
 {
   return ("0" + n.toString()).slice(-2);
 };

 function formatDate(d)
 {
   return pad2(d.getUTCMonth() + 1) + "-" + pad2(d.getUTCDate());
 }

 var interval = (maxDate - minDate) / 8;

 var xTicks = [];
 for (var i = 0; i <= 8; ++i) {
   var e = minDate + interval * i;
   var d = new Date(e);
   d.setUTCHours(0);
   d.setUTCMinutes(0);

   xTicks.push({label: formatDate(d), v: d.getTime()});
 }

 function formatPercent(v)
 {
   return (v * 100).toFixed(1) + "%";
 }

 var yTicks = [];
 interval = maxValue / 5;

 for (var i = 0; i <= 5; ++i) {
   e = interval * i;
   yTicks.push({label: formatPercent(e), v: e});
 }

 var layout = new Layout("line", {xOriginIsZero: false,
                                  xTicks: xTicks,
				  yTicks: yTicks});

 for(p = 0; p < total_platforms; ++p) {
   layout.addDataset("total_" + p, platformData[p]);
 }

 layout.evaluate();

 if (maxValue > 0) {
   var colors = [
 ]]>
 <py:for each="platform in platformList"
         py:if="len(c.params.platforms) == 0 or platform in c.params.platforms">
     Color.fromHexString('${platform.color()}'),
 </py:for>
     null
   ]; 
   colors.pop();

   var chart = new CanvasRenderer($('buildid-graph'), layout,
                {IECanvasHTC: '${h.url_for('/js/PlotKit/iecanvas.htc')}',
		 colorScheme: colors,
		 shouldStroke: true,
		 strokeColor: null,
		 strokeWidth: 2});

     chart.render();

     $('buildid-outer').style.display = 'block';
 }
 </script>

</body>
</html>
